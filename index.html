<html><head><base href=".">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ELIEZER</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<style>
body {
  background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
  min-height: 100vh;
}

.container, .container-fluid {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 10px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.logo-img { 
  max-height: 60px; 
  width: auto;
}

.navbar-brand { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
  flex-wrap: wrap;
}

.currency { 
  font-family: monospace; 
}

.table-hover tbody tr:hover { 
  background-color: rgba(0,0,0,.075); 
}

/* Responsive table styles */
@media (max-width: 768px) {
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .navbar-brand {
    font-size: 0.9em;
  }
  
  .container {
    padding: 10px;
  }
  
  .row {
    margin: 0;
  }
  
  .col-md-6 {
    padding: 10px;
  }
  
  canvas {
    max-width: 100%;
    height: auto !important;
  }
  
  .card {
    margin-bottom: 15px;
  }
}

/* Form responsiveness */
@media (max-width: 576px) {
  .form-control {
    margin-bottom: 10px;
  }
  
  .btn {
    width: 100%;
    margin-bottom: 5px;
  }
  
  .row > .col {
    flex: 0 0 100%;
    max-width: 100%;
    margin-bottom: 10px;
  }
}

/* Print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .container {
    width: 100%;
    padding: 0;
    margin: 0;
  }
}

.navbar-nav .nav-link {
  padding: 0.5rem 1rem;
  transition: all 0.3s ease;
}

.navbar-nav .nav-link:hover {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 5px;
}

.navbar-nav .bi {
  font-size: 1.1rem;
  vertical-align: middle;
}

/* Add these styles for module headers */
h2 {
  color: #1a2a6c;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #1a2a6c;
  padding-bottom: 0.5rem;
}

h2::before {
  margin-right: 0.5rem;
  font-family: "Bootstrap Icons";
}

/* Module-specific icons for headers */
[data-module="proveedor"] h2::before { content: "\f6fc"; }
[data-module="producto"] h2::before { content: "\f5eb"; }
[data-module="cliente"] h2::before { content: "\f4e1"; }
[data-module="ventas"] h2::before { content: "\f23d"; }
[data-module="historial"] h2::before { content: "\f617"; }
[data-module="reportes"] h2::before { content: "\f57c"; }
[data-module="stock"] h2::before { content: "\f5eb"; }
[data-module="config"] h2::before { content: "\f3e2"; }
[data-module="informate"] h2::before { content: "\f431"; }

.card {
  background: rgba(255, 255, 255, 0.98);
  border: none;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.navbar-collapse {
  background-color: #000000;
  padding: 10px;
  border-radius: 5px;
}

/* Adjust mobile menu styles */
@media (max-width: 991.98px) {
  .navbar-collapse {
    margin-top: 10px;
    padding: 15px;
  }
  
  .navbar-nav {
    padding: 5px 0;
  }
  
  .navbar-nav .nav-link {
    padding: 10px 15px;
    color: #ffffff !important;
  }
  
  .navbar-nav .nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
  }
}

/* Update the navbar-toggler styles */
.navbar-toggler {
    background-color: #0d6efd; /* Bootstrap primary blue */
    border-color: #0d6efd;
}

.navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 1)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
}

.navbar-toggler:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
}

.navbar-brand span#empresaNombre {
    color: #000000 !important; /* Change from #00b300 to #000000 */
}
.container {
  margin-bottom: 2rem; /* Add space for footer */
}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img id="logoImg" src alt="Logo empresa" class="logo-img">
      <span id="empresaNombre">Nombre Empresa</span>
      <span id="empresaTelefono" class="navbar-text text-light ms-3"></span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;proveedor&apos;)">
            <i class="bi bi-truck me-1"></i>Proveedores
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;producto&apos;)">
            <i class="bi bi-box-seam me-1"></i>Productos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;cliente&apos;)">
            <i class="bi bi-people-fill me-1"></i>Clientes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;ventas&apos;)">
            <i class="bi bi-cart-check me-1"></i>Ventas
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;historial&apos;)">
            <i class="bi bi-clock-history me-1"></i>Historial
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;reportes&apos;)">
            <i class="bi bi-graph-up me-1"></i>Reportes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;stock&apos;)">
            <i class="bi bi-boxes me-1"></i>Stock
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;config&apos;)">
            <i class="bi bi-gear-fill me-1"></i>Configuraci&#xf3;n
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showModule(&apos;informate&apos;)">
            <i class="bi bi-info-circle-fill me-1"></i>Inf&#xf3;rmate
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div id="mainContent"></div>
</div>

<script>if ('serviceWorker' in navigator) {}
let db;
const initDB = async () => {
  try {
    db = await idb.openDB('ventasDB', 1, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('config')) {
          db.createObjectStore('config');
        }
        ['proveedores', 'productos', 'clientes', 'ventas'].forEach(store => {
          if (!db.objectStoreNames.contains(store)) {
            db.createObjectStore(store, {
              keyPath: 'id',
              autoIncrement: true
            });
          }
        });
      }
    });
    await loadConfig();
    return true;
  } catch (error) {
    console.error('Error initializing database:', error);
    alert('Error al inicializar la base de datos. Por favor, recargue la p√°gina.');
    return false;
  }
};
window.addEventListener('offline', () => {
  alert('Conexi√≥n perdida. La aplicaci√≥n continuar√° funcionando en modo offline.');
});
window.addEventListener('online', () => {
  alert('Conexi√≥n restaurada.');
});
async function loadConfig() {
  const config = await db.get('config', 'empresaInfo');
  if (config) {
    document.getElementById('empresaNombre').textContent = config.nombre;
    document.getElementById('logoImg').src = config.logo;
    const phoneSpan = document.getElementById('empresaTelefono') || document.createElement('span');
    phoneSpan.id = 'empresaTelefono';
    phoneSpan.className = 'navbar-text text-light ms-3';
    phoneSpan.innerHTML = `<i class="bi bi-telephone-fill me-1"></i>${config.telefono}`;
    document.querySelector('.navbar-nav').after(phoneSpan);
  }
}
function formatCurrency(amount) {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'XAF',
    minimumFractionDigits: 0,
    useGrouping: true
  }).format(amount).replace(/,/g, '.');
}
function calcularCambio(total, pagoCon) {
  const billetes = [10000, 5000, 2000, 1000, 500];
  let cambio = pagoCon - total;
  const desgloseCambio = {};
  billetes.forEach(billete => {
    if (cambio >= billete) {
      const cantidad = Math.floor(cambio / billete);
      desgloseCambio[billete] = cantidad;
      cambio = cambio % billete;
    }
  });
  return desgloseCambio;
}
async function createChatbot() {
  const chatbotHTML = `
    <div id="chatbot" style="position: fixed; bottom: 20px; right: 20px; width: 350px; z-index: 1000; display: none;">
      <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span>Asistente Virtual</span>
          <div>
            <button class="btn btn-sm text-white me-2" onclick="clearChat()">
              <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-sm text-white" onclick="toggleChatbot()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
        <div class="card-body" style="height: 300px; overflow-y: auto;" id="chatMessages">
          <div class="message system">
            ¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte?
          </div>
        </div>
        <div class="card-footer">
          <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Escribe tu pregunta...">
            <button class="btn btn-primary" onclick="sendMessage()">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="text-center mt-2" style="background: rgba(0,0,0,0.9); padding: 8px; border-radius: 5px; font-size: 12px; color: white;">
        Cliqu√©a √©ste email <a href="mailto:enzemajr@gmail.com" style="text-decoration: underline; color: #0d6efd;">enzemajr@gmail.com</a> para adquirir la contrase√±a de configuraci√≥n
      </div>
    </div>
    <button id="chatbotToggle" class="btn btn-primary rounded-circle" 
            style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1000;">
      <i class="bi bi-chat-dots-fill"></i>
    </button>
  `;
  document.body.insertAdjacentHTML('beforeend', chatbotHTML);
  const styles = `
    <style>
      .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
      }
      .user {
        background-color: #e9ecef;
        margin-left: auto;
      }
      .system {
        background-color: #007bff;
        color: white;
        margin-right: auto;
      }
      #chatMessages {
        scroll-behavior: smooth;
      }
    </style>
  `;
  document.head.insertAdjacentHTML('beforeend', styles);
  document.getElementById('chatInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  document.getElementById('chatbotToggle').addEventListener('click', toggleChatbot);
}
function clearChat() {
  const messagesDiv = document.getElementById('chatMessages');
  messagesDiv.innerHTML = `
    <div class="message system">
      ¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte?
    </div>
  `;
}
function toggleChatbot() {
  const chatbot = document.getElementById('chatbot');
  const toggle = document.getElementById('chatbotToggle');
  if (chatbot.style.display === 'none') {
    chatbot.style.display = 'block';
    toggle.style.display = 'none';
  } else {
    chatbot.style.display = 'none';
    toggle.style.display = 'block';
  }
}
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  addMessage(message, 'user');
  input.value = '';
  const response = await processMessage(message.toLowerCase());
  addMessage(response, 'system');
}
function addMessage(text, type) {
  const messagesDiv = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type}`;
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
async function processMessage(message) {
  const productos = await db.getAll('productos');
  const ventas = await db.getAll('ventas');
  const clientes = await db.getAll('clientes');
  const formatNumberedList = items => {
    return items.map((item, index) => `${index + 1}. ${item}`).join('\n');
  };
  const datePattern = /ventas del (?:dia |d√≠a )?(\d{2}\/\d{2}\/\d{2}\d{2})/i;
  const dateMatch = message.match(datePattern);
  const morePattern = /productos con m[√°a]s de (\d+)/i;
  const lessPattern = /productos con menos de (\d+)/i;
  const moreMatch = message.match(morePattern);
  const lessMatch = message.match(lessPattern);
  const productSearch = productos.find(p => message.toLowerCase() === p.nombre.toLowerCase());
  if (productSearch) {
    return `üì¶ Informaci√≥n del producto:
- Nombre: ${productSearch.nombre}
- Precio: ${formatCurrency(productSearch.precio)}
- Stock actual: ${productSearch.stock} unidades
- ID: ${productSearch.id}
- Proveedor ID: ${productSearch.proveedorId}`;
  }
  if (moreMatch) {
    const cantidad = parseInt(moreMatch[1]);
    const filteredProducts = productos.filter(p => p.stock > cantidad);
    if (filteredProducts.length === 0) {
      return `No hay productos con m√°s de ${cantidad} unidades en stock.`;
    }
    const productList = filteredProducts.map(p => `${p.nombre}: ${formatCurrency(p.precio)} - Stock: ${p.stock} unidades`);
    return `üì¶ Productos con m√°s de ${cantidad} unidades:\n${formatNumberedList(productList)}`;
  }
  if (lessMatch) {
    const cantidad = parseInt(lessMatch[1]);
    const filteredProducts = productos.filter(p => p.stock < cantidad);
    if (filteredProducts.length === 0) {
      return `No hay productos con menos de ${cantidad} unidades en stock.`;
    }
    const productList = filteredProducts.map(p => `${p.nombre}: ${formatCurrency(p.precio)} - Stock: ${p.stock} unidades`);
    return `‚ö†Ô∏è Productos con menos de ${cantidad} unidades:\n${formatNumberedList(productList)}`;
  }
  if (dateMatch) {
    const searchDate = dateMatch[1];
    const [day, month, year] = searchDate.split('/');
    const targetDate = new Date(year, month - 1, day);
    const ventasDelDia = ventas.filter(venta => {
      const ventaDate = new Date(venta.fecha);
      return ventaDate.toLocaleDateString() === targetDate.toLocaleDateString();
    });
    if (ventasDelDia.length === 0) {
      return `No se encontraron ventas para el d√≠a ${searchDate}`;
    }
    const ventasList = ventasDelDia.map(v => `Venta #${v.id} - Cliente: ${v.clienteNombre} - Total: ${formatCurrency(v.total)}`);
    return `üìÖ Ventas del ${searchDate}:\n${formatNumberedList(ventasList)}`;
  }
  if (message.toLowerCase().includes('lista de productos')) {
    addMessage('¬øDeseas ver el stock de los productos? (s√≠/no)', 'system');
    window.chatbotState = 'awaitingStockConfirmation';
    return;
  }
  if (message.toLowerCase().includes('lista de clientes')) {
    const clientesList = clientes.map(c => `${c.nombre} - Tel: ${c.telefono} - Dir: ${c.direccion}`);
    return `üë• Lista de clientes:\n${formatNumberedList(clientesList)}`;
  }
  if (message.toLowerCase().includes('informaci√≥n general') || message.toLowerCase().includes('informacion general')) {
    return `‚ÑπÔ∏è Informaci√≥n General del Sistema ELIEZER:

1. Sistema de Gesti√≥n de Ventas Profesional
2. Desarrollado por: Tarciano ENZEMA NCHAMA
3. Email: enzemajr@gmail.com
4. Caracter√≠sticas principales:
   - Gesti√≥n de inventario
   - Control de ventas
   - Gesti√≥n de clientes y proveedores
   - Generaci√≥n autom√°tica de facturas
   - Reportes y estad√≠sticas
   - Control de stock
5. Fecha de creaci√≥n: 22 de noviembre del 2024 
6. Versi√≥n actual: 1.0

Nota importante: Entra en el m√≥dulo de inf√≥rmate, cliquea el email para solicitar la contrase√±a de configuraci√≥n`;
  }
  if (window.chatbotState === 'awaitingStockConfirmation') {
    window.chatbotState = null;
    if (message.toLowerCase().includes('si') || message.toLowerCase().includes('s√≠')) {
      const productList = productos.map(p => `${p.nombre}: ${formatCurrency(p.precio)} - Stock: ${p.stock} unidades`);
      return `üì¶ Lista de productos con stock:\n${formatNumberedList(productList)}`;
    }
    if (message.toLowerCase().includes('no')) {
      const productList = productos.map(p => `${p.nombre}: ${formatCurrency(p.precio)}`);
      return `üì¶ Lista de productos:\n${formatNumberedList(productList)}`;
    }
  }
  if (message.toLowerCase().includes('hola')) {
    return 'üëã ¬°Hola! ¬øEn qu√© puedo ayudarte?';
  }
  if (message.toLowerCase().includes('gracias')) {
    return 'üòä ¬°De nada! ¬øHay algo m√°s en lo que pueda ayudarte?';
  }
  if (message.toLowerCase().includes('ayuda') || message.toLowerCase().includes('help')) {
    return `ü§ñ Puedo ayudarte con:
1. Ver lista de productos (con o sin stock)
2. Ver lista de clientes
3. Ver ventas de un d√≠a espec√≠fico (formato: ventas del d√≠a DD/MM/YYYY)
4. Ver productos con m√°s de X unidades (ejemplo: productos con m√°s de 10)
5. Ver productos con menos de X unidades (ejemplo: productos con menos de 5)
6. Ver informaci√≥n general del sistema

¬øQu√© te gustar√≠a consultar?`;
  }
  return `Lo siento, no entend√≠ tu consulta. Escribe "ayuda" para ver las opciones disponibles.`;
}
async function generateInvoice(venta) {
  const {
    jsPDF
  } = window.jspdf;
  const doc = new jsPDF();
  const config = await db.get('config', 'empresaInfo');
  const colors = {
    primary: '#1a2a6c',
    secondary: '#b21f1f',
    accent: '#fdbb2d',
    text: '#2c3e50',
    light: '#ecf0f1'
  };
  let y = 20;
  doc.setFillColor(colors.primary);
  doc.rect(0, 0, 210, 40, 'F');
  doc.setFillColor(colors.secondary);
  doc.rect(0, 38, 210, 4, 'F');
  doc.setFillColor(colors.accent);
  doc.triangle(0, 0, 210, 0, 210, 20, 'F');
  if (config?.logo) {
    try {
      doc.addImage(config.logo, 'PNG', 10, 5, 30, 30);
    } catch (err) {
      console.error('Error adding logo to invoice:', err);
    }
  }
  doc.setFontSize(32);
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(0, 0, 0, 0.3);
  doc.text(config?.nombre || 'Empresa', 106, y + 1, {
    align: 'center'
  });
  doc.setTextColor(255, 255, 255);
  doc.text(config?.nombre || 'Empresa', 105, y, {
    align: 'center'
  });
  y += 12;
  doc.setFontSize(14);
  doc.text(config?.telefono || 'Tel√©fono', 105, y, {
    align: 'center'
  });
  y += 25;
  doc.setFillColor(colors.accent);
  doc.roundedRect(15, y - 7, 180, 12, 2, 2, 'F');
  doc.setTextColor(colors.primary);
  doc.setFontSize(16);
  doc.text(`FACTURA N¬∞: ${venta.id}`, 105, y, {
    align: 'center'
  });
  y += 20;
  doc.setDrawColor(colors.primary);
  doc.setLineWidth(0.5);
  doc.roundedRect(15, y - 7, 85, 25, 2, 2);
  doc.roundedRect(110, y - 7, 85, 25, 2, 2);
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(colors.primary);
  doc.text('CLIENTE:', 20, y);
  doc.text('FECHA:', 115, y);
  doc.setFont('helvetica', 'normal');
  doc.text(venta.clienteNombre, 20, y + 8);
  doc.text(new Date(venta.fecha).toLocaleString(), 115, y + 8);
  y += 30;
  doc.setFillColor(colors.primary);
  doc.rect(15, y - 7, 180, 12, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.text('PRODUCTO', 20, y);
  doc.text('CANT.', 85, y);
  doc.text('PRECIO', 120, y);
  doc.text('SUBTOTAL', 160, y);
  y += 10;
  doc.setTextColor(colors.text);
  doc.setFont('helvetica', 'normal');
  let isEven = false;
  venta.productos.forEach(producto => {
    if (isEven) {
      doc.setFillColor(240, 240, 240);
      doc.rect(15, y - 7, 180, 12, 'F');
    }
    doc.text(producto.nombre.substring(0, 30), 20, y);
    doc.text(producto.cantidad.toString(), 85, y);
    doc.text(formatCurrency(producto.precio), 120, y);
    doc.text(formatCurrency(producto.subtotal), 160, y);
    y += 10;
    isEven = !isEven;
    if (y > 250) {
      doc.addPage();
      y = 30;
    }
  });
  y += 10;
  doc.setFillColor(colors.primary);
  doc.roundedRect(110, y - 7, 85, 20, 2, 2, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.text('TOTAL:', 115, y + 5);
  doc.text(formatCurrency(venta.total), 160, y + 5);
  if (venta.pago) {
    y += 20;
    doc.setFillColor(colors.accent);
    doc.roundedRect(110, y - 7, 85, 35, 2, 2, 'F');
    doc.setTextColor(colors.primary);
    doc.setFont('helvetica', 'bold');
    doc.text('PAGO RECIBIDO:', 115, y);
    doc.text(formatCurrency(venta.pago.total), 160, y);
    doc.text('CAMBIO:', 115, y + 10);
    doc.text(formatCurrency(venta.pago.cambio), 160, y + 10);
  }
  y = 270;
  doc.setFillColor(colors.primary);
  doc.rect(0, y, 210, 30, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('Gracias por su compra', 105, y + 10, {
    align: 'center'
  });
  doc.text('Vuelva pronto', 105, y + 20, {
    align: 'center'
  });
  doc.setFillColor(255, 255, 255);
  doc.roundedRect(20, y + 5, 20, 20, 2, 2, 'F');
  doc.setFillColor(colors.primary);
  doc.roundedRect(23, y + 8, 14, 14, 1, 1, 'F');
  return doc;
}
async function processSaleSubmission(e) {
  e.preventDefault();
  const clienteId = Number(document.getElementById('clienteVenta').value);
  if (!clienteId) {
    alert('Por favor seleccione un cliente');
    return;
  }
  const cliente = await db.get('clientes', clienteId);
  if (!cliente) {
    alert('Cliente no encontrado');
    return;
  }
  const productRows = [...document.querySelectorAll('#productosVenta .row')];
  if (productRows.length === 0) {
    alert('Agregue al menos un producto');
    return;
  }
  let totalVenta = 0;
  const productosVenta = [];
  try {
    for (const row of productRows) {
      const productoId = Number(row.querySelector('.producto-select').value);
      const cantidad = Number(row.querySelector('.cantidad-input').value);
      const producto = await db.get('productos', productoId);
      if (!producto) {
        throw new Error(`Producto ${productoId} no encontrado`);
      }
      if (producto.stock < cantidad) {
        throw new Error(`Stock insuficiente para ${producto.nombre}. Stock disponible: ${producto.stock}`);
      }
      const subtotal = producto.precio * cantidad;
      totalVenta += subtotal;
      productosVenta.push({
        id: productoId,
        nombre: producto.nombre,
        cantidad: cantidad,
        precio: producto.precio,
        subtotal: subtotal
      });
    }
    const paymentModal = document.createElement('div');
    paymentModal.className = 'modal fade';
    paymentModal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Procesar Pago</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h4>Total a pagar: ${formatCurrency(totalVenta)}</h4>
                        <form id="paymentForm">
                            <div class="mb-3">
                                <h5>Billetes recibidos:</h5>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label">Billetes de 10.000 XAF:</label>
                                        <input type="number" class="form-control cantidad-billete" data-valor="10000" min="0" value="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Billetes de 5.000 XAF:</label>
                                        <input type="number" class="form-control cantidad-billete" data-valor="5000" min="0" value="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Billetes de 2.000 XAF:</label>
                                        <input type="number" class="form-control cantidad-billete" data-valor="2000" min="0" value="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Billetes de 1.000 XAF:</label>
                                        <input type="number" class="form-control cantidad-billete" data-valor="1000" min="0" value="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Billetes de 500 XAF:</label>
                                        <input type="number" class="form-control cantidad-billete" data-valor="500" min="0" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h5>Total entregado: <span id="totalEntregado">0 XAF</span></h5>
                                <h5>Cambio a devolver: <span id="cambioDevolver">0 XAF</span></h5>
                                <div id="desgloseCambio" class="alert alert-info mt-2" style="display: none;">
                                    <h6>Desglose del cambio:</h6>
                                    <ul class="list-unstyled mb-0"></ul>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmarPago" disabled>Confirmar Venta</button>
                    </div>
                </div>
            </div>
        `;
    document.body.appendChild(paymentModal);
    const modal = new bootstrap.Modal(paymentModal);
    const cantidadBilletesInputs = paymentModal.querySelectorAll('.cantidad-billete');
    cantidadBilletesInputs.forEach(input => {
      input.addEventListener('input', calculateTotal);
    });
    function calculateTotal() {
      let totalEntregado = 0;
      cantidadBilletesInputs.forEach(input => {
        const valor = Number(input.dataset.valor);
        const cantidad = Number(input.value) || 0;
        totalEntregado += valor * cantidad;
      });
      const cambio = totalEntregado - totalVenta;
      document.getElementById('totalEntregado').textContent = formatCurrency(totalEntregado);
      document.getElementById('cambioDevolver').textContent = formatCurrency(cambio);
      const desgloseCambioDiv = document.getElementById('desgloseCambio');
      const desgloseCambioList = desgloseCambioDiv.querySelector('ul');
      if (cambio > 0) {
        const desgloseCambio = calcularCambio(totalVenta, totalEntregado);
        desgloseCambioList.innerHTML = '';
        let hayBilletes = false;
        for (const [billete, cantidad] of Object.entries(desgloseCambio)) {
          if (cantidad > 0) {
            hayBilletes = true;
            desgloseCambioList.innerHTML += `
                            <li><i class="bi bi-cash"></i> ${cantidad} billete(s) de ${formatCurrency(Number(billete))}</li>
                        `;
          }
        }
        desgloseCambioDiv.style.display = hayBilletes ? 'block' : 'none';
        document.getElementById('confirmarPago').disabled = false;
      } else {
        desgloseCambioDiv.style.display = 'none';
        document.getElementById('confirmarPago').disabled = totalEntregado < totalVenta;
      }
    }
    document.getElementById('confirmarPago').addEventListener('click', async () => {
      const venta = {
        fecha: new Date(),
        clienteId,
        clienteNombre: cliente.nombre,
        productos: productosVenta,
        total: totalVenta,
        pago: {
          total: Number(document.getElementById('totalEntregado').textContent.replace(/[^0-9]/g, '')),
          cambio: Number(document.getElementById('cambioDevolver').textContent.replace(/[^0-9]/g, ''))
        }
      };
      const ventaId = await db.add('ventas', venta);
      const ventaCompleta = await db.get('ventas', ventaId);
      for (const producto of productosVenta) {
        const productoActual = await db.get('productos', producto.id);
        await db.put('productos', {
          ...productoActual,
          stock: productoActual.stock - producto.cantidad
        });
      }
      const doc = await generateInvoice(ventaCompleta);
      doc.save(`factura-${ventaId}.pdf`);
      modal.hide();
      paymentModal.remove();
      alert('Venta realizada exitosamente. La factura se descargar√° autom√°ticamente.');
      showModule('ventas');
    });
    modal.show();
    paymentModal.addEventListener('hidden.bs.modal', () => {
      paymentModal.remove();
    });
  } catch (error) {
    console.error('Error al procesar la venta:', error);
    alert(error.message || 'Error al procesar la venta. Por favor, intente nuevamente.');
  }
}
async function showModule(module) {
  const content = document.getElementById('mainContent');
  content.setAttribute('data-module', module);
  const footer = createFooter();
  switch (module) {
    case 'config':
      content.innerHTML = `
                <div class="modal fade" id="configPasswordModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Ingrese la contrase√±a</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="input-group mb-3">
                                    <input type="password" class="form-control" id="configPassword" 
                                           placeholder="Contrase√±a" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="submitPassword">Acceder</button>
                            </div>
                        </div>
                    </div>
                </div>
                ${footer}
            `;
      const modal = new bootstrap.Modal(document.getElementById('configPasswordModal'));
      modal.show();
      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('configPassword');
      togglePassword.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.querySelector('i').classList.toggle('bi-eye');
        this.querySelector('i').classList.toggle('bi-eye-slash');
      });
      document.getElementById('submitPassword').addEventListener('click', async () => {
        if (passwordInput.value === 'Ivan2022') {
          modal.hide();
          const currentConfig = (await db.get('config', 'empresaInfo')) || {};
          content.innerHTML = `
                        <h2>Configuraci√≥n</h2>
                        <form id="configForm" class="mt-4">
                            <div class="mb-3">
                                <label class="form-label">Nombre de la Empresa</label>
                                <input type="text" class="form-control" id="nombreEmpresa" value="${currentConfig.nombre || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tel√©fono de la Empresa</label>
                                <input type="tel" class="form-control" id="telefonoEmpresa" value="${currentConfig.telefono || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Logo de la Empresa</label>
                                <input type="file" class="form-control" id="logoEmpresa" accept="image/*">
                                ${currentConfig.logo ? `
                                <div class="mt-2">
                                    <label>Logo actual:</label>
                                    <img src="${currentConfig.logo}" alt="Logo actual" style="max-height: 100px; display: block;" class="mt-2">
                                </div>
                                ` : ''}
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </form>
                    ${footer}
                    `;
          document.getElementById('configForm').addEventListener('submit', async e => {
            e.preventDefault();
            const nombre = document.getElementById('nombreEmpresa').value;
            const telefono = document.getElementById('telefonoEmpresa').value;
            const logoFile = document.getElementById('logoEmpresa').files[0];
            let config = {
              nombre,
              telefono,
              logo: currentConfig.logo
            };
            if (logoFile) {
              const reader = new FileReader();
              await new Promise(resolve => {
                reader.onload = e => {
                  config.logo = e.target.result;
                  resolve();
                };
                reader.readAsDataURL(logoFile);
              });
            }
            await db.put('config', config, 'empresaInfo');
            loadConfig();
            alert('Configuraci√≥n guardada exitosamente');
          });
        } else {
          alert('Contrase√±a incorrecta. Acceso denegado.');
          modal.hide();
          showModule('ventas');
        }
      });
      passwordInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('submitPassword').click();
        }
      });
      break;
    case 'proveedor':
      content.innerHTML = `
                <h2>Gesti√≥n de Proveedores</h2>
                <form id="proveedorForm" class="mt-4">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombreProveedor" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-control" id="telefonoProveedor" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Direcci√≥n</label>
                        <input type="text" class="form-control" id="direccionProveedor" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Proveedor</button>
                </form>
                <div class="mt-4">
                    <h3>Lista de Proveedores</h3>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Direcci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="proveedoresTableBody"></tbody>
                    </table>
                </div>
            ${footer}
            `;
      const proveedores = await db.getAll('proveedores');
      const tbody = document.getElementById('proveedoresTableBody');
      tbody.innerHTML = proveedores.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.telefono}</td>
                    <td>${p.direccion}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="editProveedor(${p.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProveedor(${p.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
      document.getElementById('proveedorForm').addEventListener('submit', async e => {
        e.preventDefault();
        const proveedor = {
          nombre: document.getElementById('nombreProveedor').value,
          telefono: document.getElementById('telefonoProveedor').value,
          direccion: document.getElementById('direccionProveedor').value
        };
        await db.add('proveedores', proveedor);
        showModule('proveedor');
      });
      break;
    case 'producto':
      const proveedoresList = await db.getAll('proveedores');
      content.innerHTML = `
                <h2>Gesti√≥n de Productos</h2>
                <form id="productoForm" class="mt-4">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombreProducto" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input type="number" class="form-control" id="precioProducto" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" id="stockProducto" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Proveedor</label>
                        <select class="form-control" id="proveedorProducto" required>
                            <option value="">Seleccionar Proveedor</option>
                            ${proveedoresList.map(p => `
                                <option value="${p.id}">${p.nombre}</option>
                            `).join('')}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </form>
                <div class="mt-4">
                    <h3>Lista de Productos</h3>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productosTableBody"></tbody>
                    </table>
                </div>
            ${footer}
            `;
      const productos = await db.getAll('productos');
      document.getElementById('productosTableBody').innerHTML = await Promise.all(productos.map(async p => {
        const proveedor = await db.get('proveedores', p.proveedorId);
        return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.nombre}</td>
                        <td class="currency">${formatCurrency(p.precio)}</td>
                        <td>${p.stock}</td>
                        <td>${proveedor ? proveedor.nombre : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" onclick="editProducto(${p.id})">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProducto(${p.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
      }));
      document.getElementById('productoForm').addEventListener('submit', async e => {
        e.preventDefault();
        const producto = {
          nombre: document.getElementById('nombreProducto').value,
          precio: Number(document.getElementById('precioProducto').value),
          stock: Number(document.getElementById('stockProducto').value),
          proveedorId: Number(document.getElementById('proveedorProducto').value)
        };
        await db.add('productos', producto);
        showModule('producto');
      });
      break;
    case 'cliente':
      content.innerHTML = `
                <h2>Gesti√≥n de Clientes</h2>
                <form id="clienteForm" class="mt-4">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombreCliente" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-control" id="telefonoCliente" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Direcci√≥n</label>
                        <input type="text" class="form-control" id="direccionCliente" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                </form>
                <div class="mt-4">
                    <h3>Lista de Clientes</h3>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Direcci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTableBody"></tbody>
                    </table>
                </div>
            ${footer}
            `;
      const clientes = await db.getAll('clientes');
      document.getElementById('clientesTableBody').innerHTML = clientes.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.nombre}</td>
                    <td>${c.telefono}</td>
                    <td>${c.direccion}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="editCliente(${c.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCliente(${c.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
      document.getElementById('clienteForm').addEventListener('submit', async e => {
        e.preventDefault();
        const cliente = {
          nombre: document.getElementById('nombreCliente').value,
          telefono: document.getElementById('telefonoCliente').value,
          direccion: document.getElementById('direccionCliente').value
        };
        await db.add('clientes', cliente);
        showModule('cliente');
      });
      break;
    case 'ventas':
      const clientesList = await db.getAll('clientes');
      const productosList = await db.getAll('productos');
      content.innerHTML = `
                <h2>Nueva Venta</h2>
                <form id="ventaForm" class="mt-4">
                    <div class="mb-3">
                        <label class="form-label">Cliente</label>
                        <select class="form-control" id="clienteVenta" required>
                            <option value="">Seleccionar Cliente</option>
                            ${clientesList.map(c => `
                                <option value="${c.id}">${c.nombre}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div id="productosVenta">
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Producto</label>
                                <select class="form-control producto-select" required>
                                    <option value="">Seleccionar Producto</option>
                                    ${productosList.map(p => `
                                        <option value="${p.id}" data-precio="${p.precio}">${p.nombre} - Stock: ${p.stock}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control cantidad-input" min="1" required>
                            </div>
                            <div class="col">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control subtotal-display" readonly>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="addProductoBtn">Agregar Producto</button>
                    <div class="mt-3">
                        <h4>Total: <span id="totalVenta" class="currency">XAF 0</span></h4>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Realizar Venta</button>
                </form>
            ${footer}
            `;
      document.getElementById('addProductoBtn').addEventListener('click', () => {
        const productosDiv = document.getElementById('productosVenta');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-3';
        newRow.innerHTML = `
                    <div class="col">
                        <select class="form-control producto-select" required>
                            <option value="">Seleccionar Producto</option>
                            ${productosList.map(p => `
                                <option value="${p.id}" data-precio="${p.precio}">${p.nombre} - Stock: ${p.stock}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="col">
                        <input type="number" class="form-control cantidad-input" min="1" required>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control subtotal-display" readonly>
                    </div>
                `;
        productosDiv.appendChild(newRow);
        attachProductListeners(newRow);
      });
      function attachProductListeners(container) {
        const productoSelect = container.querySelector('.producto-select');
        const cantidadInput = container.querySelector('.cantidad-input');
        const subtotalDisplay = container.querySelector('.subtotal-display');
        function updateSubtotal() {
          const producto = productosList.find(p => p.id === Number(productoSelect.value));
          const cantidad = Number(cantidadInput.value);
          if (producto && cantidad) {
            const subtotal = producto.precio * cantidad;
            subtotalDisplay.value = formatCurrency(subtotal);
            updateTotal();
          }
        }
        productoSelect.addEventListener('change', updateSubtotal);
        cantidadInput.addEventListener('input', updateSubtotal);
      }
      function updateTotal() {
        const subtotales = [...document.getElementsByClassName('subtotal-display')].map(input => {
          const value = input.value.replace(/[^0-9]/g, '');
          return Number(value) || 0;
        });
        const total = subtotales.reduce((a, b) => a + b, 0);
        document.getElementById('totalVenta').textContent = formatCurrency(total);
      }
      attachProductListeners(document.querySelector('.row'));
      document.getElementById('ventaForm').addEventListener('submit', async e => {
        processSaleSubmission(e);
      });
      break;
    case 'historial':
      content.innerHTML = `
                <h2>Historial de Ventas</h2>
                <div class="table-responsive mt-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historialTableBody"></tbody>
                    </table>
                </div>
            ${footer}
            `;
      const ventas = await db.getAll('ventas');
      document.getElementById('historialTableBody').innerHTML = ventas.map(v => `
                <tr>
                    <td>${v.id}</td>
                    <td>${new Date(v.fecha).toLocaleString()}</td>
                    <td>${v.clienteNombre}</td>
                    <td class="currency">${formatCurrency(v.total)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="reimprimirFactura(${v.id})">
                            Reimprimir Factura
                        </button>
                        <button class="btn btn-sm btn-info me-2" onclick="verDetallesVenta(${v.id})">
                            Ver Detalles
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFactura(${v.id})">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');
      break;
    case 'reportes':
      content.innerHTML = `
                <h2>Reportes</h2>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h3>Ventas Diarias</h3>
                        <canvas id="ventasDiariasChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h3>Productos m√°s Vendidos</h3>
                        <canvas id="productosVendidosChart"></canvas>
                    </div>
                </div>
            ${footer}
            `;
      const ventasDiarias = await db.getAll('ventas');
      const ventasPorDia = ventasDiarias.reduce((acc, venta) => {
        const fecha = new Date(venta.fecha).toLocaleDateString();
        acc[fecha] = (acc[fecha] || 0) + venta.total;
        return acc;
      }, {});
      new Chart(document.getElementById('ventasDiariasChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(ventasPorDia),
          datasets: [{
            data: Object.values(ventasPorDia),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
          }]
        }
      });
      const productosMasVendidos = ventasDiarias.reduce((acc, venta) => {
        venta.productos.forEach(p => {
          acc[p.nombre] = (acc[p.nombre] || 0) + p.cantidad;
        });
        return acc;
      }, {});
      new Chart(document.getElementById('productosVendidosChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(productosMasVendidos),
          datasets: [{
            label: 'Unidades Vendidas',
            data: Object.values(productosMasVendidos),
            backgroundColor: '#36A2EB'
          }]
        }
      });
      break;
    case 'stock':
      content.innerHTML = `
                <h2>Gesti√≥n de Stock</h2>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <form id="stockForm">
                            <div class="mb-3">
                                <label class="form-label">Producto</label>
                                <select class="form-control" id="productoStock" required>
                                    <option value="">Seleccionar Producto</option>
                                    ${(await db.getAll('productos')).map(p => `
                                        <option value="${p.id}">${p.nombre} (Stock actual: ${p.stock})</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cantidad a Agregar</label>
                                <input type="number" class="form-control" id="cantidadStock" min="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Agregar Stock</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Stock Actual</h5>
                            </div>
                            <div class="card-body">
                                <div id="stockInfo">
                                    Seleccione un producto para ver detalles
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ${footer}
            `;
      document.getElementById('productoStock').addEventListener('change', async (e) => {
        const productoId = Number(e.target.value);
        if (productoId) {
          const producto = await db.get('productos', productoId);
          const proveedor = await db.get('proveedores', producto.proveedorId);
          document.getElementById('stockInfo').innerHTML = `
              <h6>${producto.nombre}</h6>
              <p><strong>Stock actual:</strong> ${producto.stock} unidades</p>
              <p><strong>Precio:</strong> ${formatCurrency(producto.precio)}</p>
              <p><strong>Proveedor:</strong> ${proveedor ? proveedor.nombre : 'N/A'}</p>
          `;
        } else {
          document.getElementById('stockInfo').innerHTML = 'Seleccione un producto para ver detalles';
        }
      });

      document.getElementById('stockForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const productoId = Number(document.getElementById('productoStock').value);
        const cantidad = Number(document.getElementById('cantidadStock').value);
        
        if (!productoId) {
          alert('Por favor seleccione un producto');
          return;
        }
        
        if (!cantidad || cantidad < 1) {
          alert('Por favor ingrese una cantidad v√°lida');
          return;
        }
        
        try {
          const producto = await db.get('productos', productoId);
          const updatedProducto = {
            ...producto,
            stock: producto.stock + cantidad
          };
          
          await db.put('productos', updatedProducto);
          alert(`Stock actualizado exitosamente. Nuevo stock: ${updatedProducto.stock} unidades`);
          showModule('stock'); // Refresh the module
        } catch (error) {
          console.error('Error al actualizar stock:', error);
          alert('Error al actualizar el stock. Por favor intente nuevamente.');
        }
      });
      break;
    case 'informate':
      content.innerHTML = `
        <div class="container py-4">
            <h2 class="text-center mb-4">Informaci√≥n del Sistema</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">¬øPara qu√© sirve esta aplicaci√≥n?</h3>
                </div>
                <div class="card-body">
                    <p>Este Sistema de Ventas Profesional es una herramienta completa dise√±ada para:
                    <ul>
                        <li>Gestionar el inventario de productos de manera eficiente</li>
                        <li>Registrar y dar seguimiento a proveedores</li>
                        <li>Mantener una base de datos actualizada de clientes</li>
                        <li>Procesar ventas de manera r√°pida y segura</li>
                        <li>Generar facturas profesionales autom√°ticamente</li>
                        <li>Visualizar reportes y estad√≠sticas de ventas</li>
                        <li>Controlar el stock de productos</li>
                    </ul>
                    <p class="mt-3"><em>El nombre ELIEZER se puso en honor a la hija del creador de esta aplicaci√≥n.</em></p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">¬øC√≥mo se maneja?</h3>
                </div>
                <div class="card-body">
                    <h5>Gu√≠a r√°pida de uso:</h5>
                    <ol>
                        <li><strong>Configuraci√≥n:</strong> Comience configurando los datos de su empresa</li>
                        <li><strong>Proveedores:</strong> Registre sus proveedores</li>
                        <li><strong>Productos:</strong> Agregue los productos al inventario</li>
                        <li><strong>Clientes:</strong> Mantenga un registro de sus clientes</li>
                        <li><strong>Ventas:</strong> Realice ventas y genere facturas autom√°ticamente</li>
                        <li><strong>Historial:</strong> Consulte el historial de ventas</li>
                        <li><strong>Reportes:</strong> Visualice estad√≠sticas y an√°lisis</li>
                        <li><strong>Stock:</strong> Controle y actualice el inventario</li>
                    </ol>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title mb-0">Sobre el Creador</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h4>Tarciano ENZEMA NCHAMA</h4>
                            <p class="lead">Desarrollador del Sistema</p>
                            <hr>
                            <p><strong>Email:</strong> <a href="mailto:enzemajr@gmail.com" onclick="window.location.href='mailto:enzemajr@gmail.com'">enzemajr@gmail.com</a></p>
                            <p><strong>Formaci√≥n:</strong> Finalista universitario de la UNGE</p>
                            <p><strong>Facultad:</strong> CIENCIAS ECON√ìMICAS, GESTI√ìN Y ADMINISTRACI√ìN</p>
                            <p><strong>Departamento:</strong> INFORM√ÅTICA DE GESTI√ìN EMPRESARIAL</p>
                            <p><strong>Fecha de Creaci√≥n:</strong> 22 de noviembre del 2024</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="bg-light p-4 rounded">
                                <div class="mb-3">
                                    <img src="ivan.jpg" alt="Foto del Creador" 
                                         class="img-fluid rounded-circle mb-3" 
                                         style="width: 150px; height: 150px; object-fit: cover;">
                                </div>
                                <p class="mt-2 text-muted">Desarrollador</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        ${footer}
      `;
      break;
  }
}
async function editProveedor(id) {
  const proveedor = await db.get('proveedores', id);
  const form = document.getElementById('proveedorForm');
  document.getElementById('nombreProveedor').value = proveedor.nombre;
  document.getElementById('telefonoProveedor').value = proveedor.telefono;
  document.getElementById('direccionProveedor').value = proveedor.direccion;
  if (!document.getElementById('proveedorId')) {
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.id = 'proveedorId';
    form.appendChild(idInput);
  }
  document.getElementById('proveedorId').value = id;
  form.querySelector('button[type="submit"]').textContent = 'Actualizar Proveedor';
  form.onsubmit = async e => {
    e.preventDefault();
    const updatedProveedor = {
      id: Number(document.getElementById('proveedorId').value),
      nombre: document.getElementById('nombreProveedor').value,
      telefono: document.getElementById('telefonoProveedor').value,
      direccion: document.getElementById('direccionProveedor').value
    };
    await db.put('proveedores', updatedProveedor);
    showModule('proveedor');
  };
}
async function editProducto(id) {
  const producto = await db.get('productos', id);
  const form = document.getElementById('productoForm');
  document.getElementById('nombreProducto').value = producto.nombre;
  document.getElementById('precioProducto').value = producto.precio;
  document.getElementById('stockProducto').value = producto.stock;
  document.getElementById('proveedorProducto').value = producto.proveedorId;
  if (!document.getElementById('productoId')) {
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.id = 'productoId';
    form.appendChild(idInput);
  }
  document.getElementById('productoId').value = id;
  form.querySelector('button[type="submit"]').textContent = 'Actualizar Producto';
  form.onsubmit = async e => {
    e.preventDefault();
    const updatedProducto = {
      id: Number(document.getElementById('productoId').value),
      nombre: document.getElementById('nombreProducto').value,
      precio: Number(document.getElementById('precioProducto').value),
      stock: Number(document.getElementById('stockProducto').value),
      proveedorId: Number(document.getElementById('proveedorProducto').value)
    };
    await db.put('productos', updatedProducto);
    showModule('producto');
  };
}
async function editCliente(id) {
  const cliente = await db.get('clientes', id);
  const form = document.getElementById('clienteForm');
  document.getElementById('nombreCliente').value = cliente.nombre;
  document.getElementById('telefonoCliente').value = cliente.telefono;
  document.getElementById('direccionCliente').value = cliente.direccion;
  if (!document.getElementById('clienteId')) {
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.id = 'clienteId';
    form.appendChild(idInput);
  }
  document.getElementById('clienteId').value = id;
  form.querySelector('button[type="submit"]').textContent = 'Actualizar Cliente';
  form.onsubmit = async e => {
    e.preventDefault();
    const updatedCliente = {
      id: Number(document.getElementById('clienteId').value),
      nombre: document.getElementById('nombreCliente').value,
      telefono: document.getElementById('telefonoCliente').value,
      direccion: document.getElementById('direccionCliente').value
    };
    await db.put('clientes', updatedCliente);
    showModule('cliente');
  };
}
async function deleteProveedor(id) {
  if (confirm('¬øEst√° seguro de eliminar este proveedor?')) {
    await db.delete('proveedores', id);
    showModule('proveedor');
  }
}
async function deleteProducto(id) {
  if (confirm('¬øEst√° seguro de eliminar este producto?')) {
    await db.delete('productos', id);
    showModule('producto');
  }
}
async function deleteCliente(id) {
  if (confirm('¬øEst√° seguro de eliminar este cliente?')) {
    await db.delete('clientes', id);
    showModule('cliente');
  }
}
async function deleteFactura(id) {
  const modalHTML = `
        <div class="modal fade" id="deleteFacturaModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Ingrese la contrase√±a para eliminar</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <input type="password" class="form-control" id="deleteFacturaPassword" 
                                   placeholder="Contrase√±a" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleDeletePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmDelete">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  const modal = new bootstrap.Modal(document.getElementById('deleteFacturaModal'));
  const togglePassword = document.getElementById('toggleDeletePassword');
  const passwordInput = document.getElementById('deleteFacturaPassword');
  togglePassword.addEventListener('click', function () {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.querySelector('i').classList.toggle('bi-eye');
    this.querySelector('i').classList.toggle('bi-eye-slash');
  });
  document.getElementById('confirmDelete').addEventListener('click', async () => {
    const hashPassword = str => {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        hash = hash & hash;
      }
      return hash;
    };
    const correctHash = hashPassword("INGE2024");
    const password = passwordInput.value;
    if (hashPassword(password) === correctHash) {
      if (confirm('¬øEst√° seguro de eliminar esta factura?')) {
        try {
          await db.delete('ventas', id);
          alert('Factura eliminada exitosamente');
          modal.hide();
          document.getElementById('deleteFacturaModal').remove();
          showModule('historial');
        } catch (error) {
          console.error('Error al eliminar factura:', error);
          alert('Error al eliminar la factura');
        }
      }
    } else {
      alert('Contrase√±a incorrecta');
    }
  });
  document.getElementById('deleteFacturaModal').addEventListener('hidden.bs.modal', function () {
    this.remove();
  });
  modal.show();
}
async function reimprimirFactura(ventaId) {
  try {
    const venta = await db.get('ventas', ventaId);
    if (!venta) {
      alert('No se encontr√≥ la venta especificada');
      return;
    }
    const doc = await generateInvoice(venta);
    doc.save(`factura-${ventaId}.pdf`);
  } catch (error) {
    console.error('Error al reimprimir factura:', error);
    alert('Error al reimprimir la factura. Por favor intente nuevamente.');
  }
}
async function verDetallesVenta(ventaId) {
  const venta = await db.get('ventas', ventaId);
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Venta #${venta.id}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Cliente:</strong> ${venta.clienteNombre}</p>
                    <p><strong>Fecha:</strong> ${new Date(venta.fecha).toLocaleString()}</p>
                    <h6>Productos:</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${venta.productos.map(p => `
                                <tr>
                                    <td>${p.nombre}</td>
                                    <td>${p.cantidad}</td>
                                    <td class="currency">${formatCurrency(p.precio)}</td>
                                    <td class="currency">${formatCurrency(p.subtotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td class="currency"><strong>${formatCurrency(venta.total)}</strong></td>
                            </tr>
                        </tfoot>
                    </tbody>
                    ${venta.pago ? `
                    <h6>Detalles de Pago:</h6>
                    <p><strong>Total Recibido:</strong> ${formatCurrency(venta.pago.total)}</p>
                    <p><strong>Cambio:</strong> ${formatCurrency(venta.pago.cambio)}</p>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="reimprimirFactura(${venta.id})">
                        Reimprimir Factura
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    `;
  document.body.appendChild(modal);
  const modalInstance = new bootstrap.Modal(modal);
  modalInstance.show();
  modal.addEventListener('hidden.bs.modal', () => {
    modal.remove();
  });
}
function createFooter() {
  const footerHTML = `
    <div class="text-center mt-4 py-3" style="background: rgba(0,0,0,0.9); padding: 8px; border-radius: 5px; font-size: 10px; color: white;">
      Cliqu√©a √©ste email <a href="mailto:enzemajr@gmail.com" style="text-decoration: underline; color: #0d6efd;">enzemajr@gmail.com</a> para adquirir la contrase√±a de configuraci√≥n
    </div>
  `;
  return footerHTML;
}
window.addEventListener('load', async () => {
  await initDB();
  await createChatbot();
  showModule('ventas');
});</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body></html>